<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMK Money Solution - Complete Loan Application System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary: #1a73e8;
            --primary-light: #e8f0fe;
            --primary-dark: #0d47a1;
            --secondary: #ff6d00;
            --secondary-light: #ffe0b2;
            --accent: #00c853;
            --accent-light: #c8e6c9;
            --text-dark: #202124;
            --text-light: #5f6368;
            --white: #ffffff;
            --grey-light: #f8f9fa;
            --grey: #dadce0;
            --grey-dark: #5f6368;
            --success: #0f9d58;
            --warning: #f4b400;
            --error: #ea4335;
            --radius: 8px;
            --radius-large: 12px;
            --shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 3px 10px rgba(0, 0, 0, 0.12);
            --shadow-large: 0 6px 20px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--text-dark);
            min-height: 100vh;
            font-size: 14px;
            line-height: 1.4;
            padding-bottom: 60px;
        }

        header {
            background: var(--white);
            padding: 10px 14px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo {
            width: 34px;
            height: 34px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: var(--shadow);
        }

        .logo-text h1 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .logo-text p {
            margin: 0;
            font-size: 11px;
            color: var(--text-light);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-icon, .menu-toggle {
            background: var(--grey-light);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            border: none;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-icon:hover, .menu-toggle:hover {
            background: var(--grey);
        }

        main {
            padding: 14px;
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            margin: 16px 0 12px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-title i {
            color: var(--primary);
        }

        .card {
            background: var(--white);
            border-radius: var(--radius-large);
            padding: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-medium);
        }

        .loan-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: var(--radius-large);
            padding: 18px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 18px;
            position: relative;
            overflow: hidden;
        }

        .loan-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(30deg);
        }

        .loan-card h2 {
            margin: 0 0 6px;
            font-size: 17px;
            font-weight: 600;
            position: relative;
        }

        .loan-card p {
            margin: 0 0 14px;
            font-size: 13px;
            opacity: 0.9;
            position: relative;
        }

        .loan-amount {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 6px;
            position: relative;
        }

        .loan-range {
            font-size: 13px;
            opacity: 0.8;
            position: relative;
        }

        .interest-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 14px;
            position: relative;
        }

        .interest-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--radius);
            padding: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }

        .interest-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .interest-period {
            font-size: 12px;
            opacity: 0.9;
        }

        .interest-rate {
            font-size: 14px;
            font-weight: 600;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .feature-item {
            background: var(--white);
            border-radius: var(--radius-large);
            padding: 14px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .feature-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .feature-icon {
            background: var(--primary-light);
            color: var(--primary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            box-shadow: var(--shadow);
        }

        .feature-text {
            font-size: 13px;
            font-weight: 500;
        }

        .apply-btn {
            display: block;
            width: 100%;
            background: var(--primary);
            color: white;
            text-align: center;
            border: none;
            border-radius: var(--radius-large);
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            margin-top: 18px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-medium);
        }

        .apply-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .apply-btn:disabled {
            background: var(--grey);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .contact-card {
            background: var(--white);
            border-radius: var(--radius-large);
            padding: 16px;
            margin-top: 18px;
            box-shadow: var(--shadow);
        }

        .contact-card strong {
            color: var(--primary);
            font-size: 14px;
        }

        .contact-info {
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.4;
        }

        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--white);
            display: flex;
            justify-content: space-around;
            border-top: 1px solid var(--grey);
            padding: 10px 0;
            z-index: 100;
            box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 11px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            padding: 6px 10px;
            border-radius: var(--radius-large);
            width: 20%;
        }

        .nav-item i {
            font-size: 18px;
            margin-bottom: 3px;
        }

        .nav-item.active {
            color: var(--primary);
            background: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .hidden {
            display: none;
        }

        .page {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--grey);
            border-radius: var(--radius);
            font-size: 14px;
            transition: var(--transition);
            background: var(--white);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--grey);
            border-radius: var(--radius);
            font-size: 14px;
            background-color: var(--white);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%23666' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 10px;
            transition: var(--transition);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .application-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 18px;
            position: relative;
        }

        .application-steps::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--grey);
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--grey);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            margin-bottom: 6px;
            transition: var(--transition);
        }

        .step.active .step-circle {
            background: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }

        .step.completed .step-circle {
            background: var(--success);
        }

        .step-label {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 500;
        }

        .step.active .step-label {
            color: var(--primary);
            font-weight: 600;
        }

        .file-upload {
            border: 2px dashed var(--grey);
            border-radius: 50%;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--grey-light);
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .file-upload.has-image {
            border: none;
            padding: 0;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .file-upload i {
            font-size: 22px;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .file-upload-text {
            font-size: 12px;
            color: var(--text-light);
        }

        .remove-preview {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
        }

        .collateral-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px;
        }

        .collateral-item {
            background: var(--white);
            border: 1px solid var(--grey);
            border-radius: var(--radius);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .collateral-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .collateral-item.selected {
            border-color: var(--primary);
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .collateral-icon {
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .collateral-name {
            font-size: 12px;
            font-weight: 500;
        }

        .doc-upload {
            border: 2px dashed var(--grey);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--grey-light);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            min-height: 100px;
        }

        .doc-upload.has-image {
            border: none;
            padding: 0;
        }

        .doc-upload:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .doc-upload i {
            font-size: 22px;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .doc-upload-text {
            font-size: 13px;
            color: var(--text-light);
        }

        .form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 18px;
        }

        .btn-secondary {
            background: var(--grey-light);
            color: var(--text-dark);
            border: none;
            border-radius: var(--radius-large);
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .btn-secondary:hover {
            background: var(--grey);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-large);
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-medium);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-primary:disabled {
            background: var(--grey);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .amount-input-container {
            position: relative;
            margin-bottom: 16px;
        }

        .amount-input {
            width: 100%;
            padding: 14px 14px 14px 36px;
            border: 1px solid var(--grey);
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            background: var(--white);
        }

        .amount-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        .currency-symbol {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .repayment-summary {
            background: var(--primary-light);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 16px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .summary-total {
            font-weight: 600;
            border-top: 1px solid var(--grey);
            padding-top: 10px;
            margin-top: 10px;
        }

        .floating-form {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-large);
            padding: 18px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .error-message {
            color: var(--error);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .form-input.error {
            border-color: var(--error);
        }

        .toast {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-medium);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            animation: toastIn 0.3s ease;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--error);
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .loan-item {
            background: var(--white);
            border-radius: var(--radius-large);
            padding: 16px;
            margin-bottom: 14px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .loan-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .loan-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
        }

        .loan-details {
            flex: 1;
        }

        .loan-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .loan-date {
            font-size: 12px;
            color: var(--text-light);
        }

        .loan-amount-badge {
            background: var(--primary-light);
            color: var(--primary);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .loan-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .loan-info-label {
            color: var(--text-light);
        }

        .loan-info-value {
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 36px 16px;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 36px;
            margin-bottom: 14px;
            opacity: 0.5;
        }

        .empty-state p {
            margin: 0;
            font-size: 13px;
        }

        .progress-bar {
            height: 5px;
            background: var(--grey);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .referral-banner {
            background: linear-gradient(135deg, var(--secondary) 0%, #ff9800 100%);
            color: white;
            border-radius: var(--radius-large);
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-medium);
        }

        .referral-banner i {
            font-size: 24px;
        }

        .referral-content h3 {
            margin: 0 0 5px;
            font-size: 16px;
        }

        .referral-content p {
            margin: 0;
            font-size: 13px;
            opacity: 0.9;
        }

        .loan-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-pending {
            background: var(--warning);
            color: white;
        }

        .status-approved {
            background: var(--success);
            color: white;
        }

        .status-rejected {
            background: var(--error);
            color: white;
        }

        .status-completed {
            background: var(--primary);
            color: white;
        }

        .side-panel {
            position: fixed;
            top: 0;
            right: -280px;
            width: 260px;
            height: 100%;
            background: var(--white);
            box-shadow: -2px 0 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .side-panel.open {
            right: 0;
        }

        .panel-header {
            padding: 20px 16px;
            border-bottom: 1px solid var(--grey);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--grey-light);
        }

        .panel-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .close-panel {
            background: none;
            border: none;
            font-size: 16px;
            color: var(--text-light);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close-panel:hover {
            background: var(--grey);
        }

        .panel-content {
            padding: 16px;
        }

        .panel-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--grey-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .panel-item:hover {
            background: var(--grey-light);
            border-radius: var(--radius);
            padding-left: 8px;
        }

        .panel-item i {
            margin-right: 12px;
            color: var(--primary);
            width: 18px;
            text-align: center;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            backdrop-filter: blur(5px);
        }

        .overlay.active {
            display: block;
        }

        .notification-panel {
            position: fixed;
            top: 0;
            right: -280px;
            width: 260px;
            height: 100%;
            background: var(--white);
            box-shadow: -2px 0 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .notification-panel.open {
            right: 0;
        }

        .notification-item {
            padding: 12px 14px;
            border-bottom: 1px solid var(--grey-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-item:hover {
            background: var(--grey-light);
        }

        .notification-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        .notification-time {
            font-size: 11px;
            color: var(--grey-dark);
        }

        .floating-btn {
            position: fixed;
            bottom: 70px;
            right: 16px;
            width: 54px;
            height: 54px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow-large);
            cursor: pointer;
            z-index: 90;
            transition: var(--transition);
        }

        .floating-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-3px) scale(1.05);
            box-shadow: var(--shadow-large);
        }

        .repayment-schedule {
            margin-top: 16px;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--grey-light);
        }

        .schedule-item:last-child {
            border-bottom: none;
        }

        .schedule-date {
            font-weight: 500;
        }

        .schedule-amount {
            color: var(--primary);
            font-weight: 600;
        }

        .calculator-card {
            background: var(--white);
            border-radius: var(--radius-large);
            padding: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }

        .calculator-result {
            text-align: center;
            padding: 16px;
            background: var(--primary-light);
            border-radius: var(--radius);
            margin-top: 16px;
        }

        .result-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .result-label {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 4px;
        }
        
        .upload-progress {
            width: 100%;
            height: 4px;
            background: var(--grey);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
            display: none;
        }
        
        .upload-progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .payment-card {
            background: var(--white);
            border-radius: var(--radius-large);
            padding: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }
        
        .payment-methods {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .payment-method {
            flex: 1;
            border: 1px solid var(--grey);
            border-radius: var(--radius);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .payment-method.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        
        .payment-method i {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .payment-method-name {
            font-size: 12px;
            font-weight: 500;
        }
        
        .referral-code {
            background: var(--primary-light);
            border-radius: var(--radius);
            padding: 12px;
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .referral-code-text {
            font-family: monospace;
            font-weight: 600;
            font-size: 14px;
        }
        
        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: var(--radius-large);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .login-form {
            background: var(--white);
            border-radius: var(--radius-large);
            padding: 20px;
            box-shadow: var(--shadow-medium);
            margin-top: 40px;
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .login-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-large);
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            margin-top: 16px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .login-btn:hover {
            background: var(--primary-dark);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--grey);
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .auth-tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        /* NEW STYLES FOR ENHANCED FEATURES */
        
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--error);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 13px;
            z-index: 1001;
            display: none;
        }
        
        .offline-indicator.show {
            display: block;
        }
        
        .document-checklist {
            background: var(--accent-light);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 16px;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checklist-item i {
            margin-right: 10px;
            color: var(--accent);
        }
        
        .checklist-item.completed {
            color: var(--success);
        }
        
        .checklist-item.completed i {
            color: var(--success);
        }
        
        .guarantor-section {
            border-top: 1px solid var(--grey);
            padding-top: 16px;
            margin-top: 16px;
        }
        
        .financial-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .bank-details {
            background: var(--primary-light);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 16px;
        }
        
        .employment-history {
            margin-top: 16px;
        }
        
        .history-item {
            background: var(--grey-light);
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .history-company {
            font-weight: 600;
        }
        
        .history-period {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .history-position {
            font-size: 13px;
        }
        
        .credit-score-display {
            text-align: center;
            margin: 16px 0;
        }
        
        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: conic-gradient(var(--success) 0% 70%, var(--warning) 70% 90%, var(--error) 90% 100%);
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .score-circle::before {
            content: '';
            position: absolute;
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
        }
        
        .score-value {
            position: relative;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .score-label {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .loan-purpose-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px;
        }
        
        .purpose-item {
            background: var(--white);
            border: 1px solid var(--grey);
            border-radius: var(--radius);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .purpose-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .purpose-item.selected {
            border-color: var(--primary);
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .purpose-icon {
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 6px;
        }
        
        .purpose-name {
            font-size: 12px;
            font-weight: 500;
        }
        
        .additional-docs {
            margin-top: 16px;
        }
        
        .doc-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .doc-item {
            flex: 1;
        }
        
        .terms-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: var(--radius-large);
            padding: 20px;
            box-shadow: var(--shadow-large);
            z-index: 1002;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }
        
        .terms-modal.show {
            display: block;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--grey);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 16px;
            color: var(--text-light);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .close-modal:hover {
            background: var(--grey);
        }
        
        .modal-content {
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-light);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            display: none;
            backdrop-filter: blur(5px);
        }
        
        .modal-overlay.active {
            display: block;
        }
        
        .application-timeline {
            margin-top: 16px;
        }
        
        .timeline-item {
            display: flex;
            margin-bottom: 16px;
            position: relative;
        }
        
        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 24px;
            left: 11px;
            height: calc(100% + 16px);
            width: 2px;
            background: var(--grey);
        }
        
        .timeline-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--grey);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            margin-right: 12px;
            z-index: 1;
        }
        
        .timeline-item.completed .timeline-icon {
            background: var(--success);
        }
        
        .timeline-item.active .timeline-icon {
            background: var(--primary);
        }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .timeline-date {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .timeline-description {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 4px;
        }
        
        .dashboard-widgets {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
        
        .dashboard-widget {
            background: var(--white);
            border-radius: var(--radius-large);
            padding: 16px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .widget-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-light);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 18px;
        }
        
        .widget-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .widget-label {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 16px;
        }
        
        .quick-action {
            background: var(--white);
            border-radius: var(--radius);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }
        
        .quick-action:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .action-icon {
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 6px;
        }
        
        .action-text {
            font-size: 12px;
            font-weight: 500;
        }
        
        .application-summary {
            background: var(--primary-light);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 16px;
        }
        
        .summary-section {
            margin-bottom: 16px;
        }
        
        .summary-section:last-child {
            margin-bottom: 0;
        }
        
        .summary-section-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--primary-dark);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .summary-item-label {
            color: var(--text-light);
        }
        
        .summary-item-value {
            font-weight: 500;
        }
        
        .loan-comparison {
            margin-top: 16px;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--grey);
        }
        
        .comparison-table th {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-dark);
        }
        
        .comparison-table td {
            font-size: 13px;
            color: var(--text-light);
        }
        
        .comparison-table tr:last-child td {
            border-bottom: none;
        }
        
        .recommended {
            background: var(--accent-light);
            border-left: 3px solid var(--accent);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }
        
        .badge-success {
            background: var(--success);
            color: white;
        }
        
        .badge-warning {
            background: var(--warning);
            color: white;
        }
        
        .badge-primary {
            background: var(--primary);
            color: white;
        }
        
        .application-fee {
            background: var(--warning);
            color: white;
            border-radius: var(--radius);
            padding: 12px;
            margin-top: 16px;
            text-align: center;
            font-size: 13px;
        }
        
        .fee-amount {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .application-tips {
            background: var(--accent-light);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 16px;
        }
        
        .tip-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .tip-item:last-child {
            margin-bottom: 0;
        }
        
        .tip-icon {
            color: var(--accent);
            margin-right: 10px;
            margin-top: 2px;
        }
        
        .tip-content {
            flex: 1;
            font-size: 13px;
            color: var(--text-dark);
        }
        
        .repayment-options {
            margin-top: 16px;
        }
        
        .option-item {
            background: var(--white);
            border: 1px solid var(--grey);
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .option-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .option-item.selected {
            border-color: var(--primary);
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .option-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .option-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .option-rate {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .option-details {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .application-success {
            text-align: center;
            padding: 30px 20px;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--success);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 36px;
        }
        
        .success-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .success-message {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 20px;
        }
        
        .application-id {
            background: var(--primary-light);
            border-radius: var(--radius);
            padding: 12px;
            margin: 20px 0;
            font-family: monospace;
            font-weight: 600;
            font-size: 16px;
            text-align: center;
        }
        
        .next-steps {
            text-align: left;
            margin-top: 20px;
        }
        
        .step-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .step-description {
            font-size: 13px;
            color: var(--text-light);
        }
        
        .application-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--grey);
        }
        
        .status-indicator.active {
            background: var(--primary);
        }
        
        .status-indicator.completed {
            background: var(--success);
        }
        
        .status-text {
            font-size: 13px;
            font-weight: 500;
        }
        
        .application-documents {
            margin-top: 20px;
        }
        
        .document-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--grey-light);
            border-radius: var(--radius);
            margin-bottom: 10px;
        }
        
        .document-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .document-icon {
            color: var(--primary);
            font-size: 18px;
        }
        
        .document-name {
            font-size: 13px;
            font-weight: 500;
        }
        
        .document-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: var(--grey);
            color: var(--text-light);
        }
        
        .document-status.uploaded {
            background: var(--success);
            color: white;
        }
        
        .document-status.pending {
            background: var(--warning);
            color: white;
        }
        
        .support-section {
            margin-top: 20px;
        }
        
        .support-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px;
        }
        
        .support-option {
            background: var(--white);
            border-radius: var(--radius);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }
        
        .support-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .support-icon {
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 6px;
        }
        
        .support-text {
            font-size: 12px;
            font-weight: 500;
        }
        
        .application-faq {
            margin-top: 20px;
        }
        
        .faq-item {
            background: var(--white);
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }
        
        .faq-item:hover {
            box-shadow: var(--shadow-medium);
        }
        
        .faq-question {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .faq-answer {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 8px;
            display: none;
        }
        
        .faq-item.active .faq-answer {
            display: block;
        }
        
        .faq-toggle {
            color: var(--primary);
            transition: var(--transition);
        }
        
        .faq-item.active .faq-toggle {
            transform: rotate(180deg);
        }
        
        .application-security {
            background: var(--primary-light);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 20px;
            text-align: center;
        }
        
        .security-icon {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .security-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
        }
        
        .security-text {
            font-size: 12px;
            color: var(--text-light);
        }
    </style>
</head>
<body>
    <div class="offline-indicator" id="offline-indicator">
        <i class="fas fa-wifi"></i> You are currently offline. Some features may not work properly.
    </div>

    <header>
        <div class="header-content">
            <div class="logo-container">
                <div class="logo">DMK</div>
                <div class="logo-text">
                    <h1>DMK Money</h1>
                    <p>Instant Cash, Lasting Trust</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="notification-icon" id="notification-toggle">
                    <i class="fa-solid fa-bell"></i>
                    <div class="notification-badge" id="notification-count" style="display: none;">0</div>
                </div>
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <main>
        <!-- Login/Signup Page -->
        <div id="auth-page" class="page">
            <div class="login-form">
                <div class="login-title">Welcome to DMK Money</div>
                
                <div class="auth-tabs">
                    <button class="auth-tab active" id="login-tab">Login</button>
                    <button class="auth-tab" id="signup-tab">Sign Up</button>
                </div>
                
                <div id="login-form">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="login-email" placeholder="your@email.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="login-password" placeholder="Enter your password">
                    </div>
                    
                    <button class="login-btn" onclick="login()">Login</button>
                </div>
                
                <div id="signup-form" class="hidden">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="signup-name" placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="signup-email" placeholder="your@email.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="signup-phone" placeholder="+260 XXX XXX XXX">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="signup-password" placeholder="Create a password">
                    </div>
                    
                    <button class="login-btn" onclick="signup()">Create Account</button>
                </div>
            </div>
        </div>

        <!-- Home Page -->
        <div id="home-page" class="page hidden">
            <div class="referral-banner">
                <i class="fa-solid fa-gift"></i>
                <div class="referral-content">
                    <h3>Refer & Earn 5% Bonus!</h3>
                    <p>Invite friends and get cash rewards when they apply for a loan</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-loans">0</div>
                    <div class="stat-label">Total Loans</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="active-loans">0</div>
                    <div class="stat-label">Active Loans</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="credit-score">-</div>
                    <div class="stat-label">Credit Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="referral-earnings">K0</div>
                    <div class="stat-label">Referral Earnings</div>
                </div>
            </div>

            <div class="dashboard-widgets">
                <div class="dashboard-widget">
                    <div class="widget-icon">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                    <div class="widget-value" id="next-payment">K0</div>
                    <div class="widget-label">Next Payment</div>
                </div>
                <div class="dashboard-widget">
                    <div class="widget-icon">
                        <i class="fa-solid fa-calendar"></i>
                    </div>
                    <div class="widget-value" id="due-date">-</div>
                    <div class="widget-label">Due Date</div>
                </div>
                <div class="dashboard-widget">
                    <div class="widget-icon">
                        <i class="fa-solid fa-percentage"></i>
                    </div>
                    <div class="widget-value" id="interest-rate">0%</div>
                    <div class="widget-label">Interest Rate</div>
                </div>
                <div class="dashboard-widget">
                    <div class="widget-icon">
                        <i class="fa-solid fa-wallet"></i>
                    </div>
                    <div class="widget-value" id="available-limit">K6,000</div>
                    <div class="widget-label">Available Limit</div>
                </div>
            </div>

            <div class="loan-card">
                <h2>Quick Loan Options</h2>
                <p>Get instant cash when you need it most</p>
                <div class="loan-amount">K6,000</div>
                <div class="loan-range">Borrow from K100 to K6,000</div>
                
                <div class="interest-grid">
                    <div class="interest-item">
                        <div class="interest-period">1 Week</div>
                        <div class="interest-rate">20%</div>
                    </div>
                    <div class="interest-item">
                        <div class="interest-period">2 Weeks</div>
                        <div class="interest-rate">25%</div>
                    </div>
                    <div class="interest-item">
                        <div class="interest-period">1 Month</div>
                        <div class="interest-rate">35%</div>
                    </div>
                </div>
            </div>

            <div class="quick-actions">
                <div class="quick-action" onclick="showPage('apply-page')">
                    <div class="action-icon">
                        <i class="fa-solid fa-paper-plane"></i>
                    </div>
                    <div class="action-text">Apply Now</div>
                </div>
                <div class="quick-action" onclick="showPage('payments-page')">
                    <div class="action-icon">
                        <i class="fa-solid fa-credit-card"></i>
                    </div>
                    <div class="action-text">Make Payment</div>
                </div>
                <div class="quick-action" onclick="showReferralSection()">
                    <div class="action-icon">
                        <i class="fa-solid fa-share-alt"></i>
                    </div>
                    <div class="action-text">Refer & Earn</div>
                </div>
                <div class="quick-action" onclick="showPage('loans-page')">
                    <div class="action-icon">
                        <i class="fa-solid fa-history"></i>
                    </div>
                    <div class="action-text">Loan History</div>
                </div>
            </div>

            <div class="calculator-card">
                <h3 class="section-title"><i class="fa-solid fa-calculator"></i> Loan Calculator</h3>
                <div class="form-group">
                    <label class="form-label">Loan Amount (K)</label>
                    <input type="number" class="form-input" id="calc-amount" min="100" max="6000" value="2500" oninput="calculateLoan()">
                </div>
                <div class="form-group">
                    <label class="form-label">Repayment Period</label>
                    <select class="form-select" id="calc-period" onchange="calculateLoan()">
                        <option value="7">1 Week</option>
                        <option value="14">2 Weeks</option>
                        <option value="21">3 Weeks</option>
                        <option value="30" selected>1 Month</option>
                        <option value="60">2 Months</option>
                    </select>
                </div>
                <div class="calculator-result">
                    <div class="result-amount" id="calc-total">K3,425</div>
                    <div class="result-label">Total Repayment Amount</div>
                </div>
            </div>

            <h3 class="section-title"><i class="fa-solid fa-star"></i> Why Choose DMK</h3>
            <div class="features-grid">
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fa-solid fa-bolt"></i>
                    </div>
                    <div class="feature-text">Instant Approval</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fa-solid fa-calendar"></i>
                    </div>
                    <div class="feature-text">Flexible Terms</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fa-solid fa-user-group"></i>
                    </div>
                    <div class="feature-text">Refer & Earn</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fa-solid fa-mobile-screen"></i>
                    </div>
                    <div class="feature-text">Easy Application</div>
                </div>
            </div>

            <button class="apply-btn" onclick="showPage('apply-page')">Apply Now</button>

            <div class="contact-card">
                <strong>Contact Us</strong>
                <div class="contact-info">
                    House #39 Chiyele Rd, Chilenje South<br>
                    <strong>Phone:</strong> +260 777 602240 / +260 954 035914<br>
                    <strong>Email:</strong> info@dmkmoney.co.zm<br>
                    <strong>Hours:</strong> Mon-Fri 8:00 AM - 5:00 PM
                </div>
            </div>
        </div>

        <!-- Loans Page -->
        <div id="loans-page" class="page hidden">
            <h3 class="section-title"><i class="fa-solid fa-hand-holding-dollar"></i> My Loans</h3>
            
            <div id="active-loans-container">
                <div class="empty-state">
                    <i class="fa-solid fa-hand-holding-dollar"></i>
                    <p>No active loans</p>
                </div>
            </div>
            
            <h3 class="section-title"><i class="fa-solid fa-clock"></i> Pending Applications</h3>
            
            <div id="pending-applications-container">
                <div class="empty-state">
                    <i class="fa-solid fa-clock"></i>
                    <p>No pending applications</p>
                </div>
            </div>
            
            <h3 class="section-title"><i class="fa-solid fa-receipt"></i> Loan History</h3>
            
            <div id="loan-history-container">
                <div class="empty-state">
                    <i class="fa-solid fa-receipt"></i>
                    <p>No previous loans</p>
                </div>
            </div>
        </div>

        <!-- Apply Page -->
        <div id="apply-page" class="page hidden">
            <h3 class="section-title"><i class="fa-solid fa-paper-plane"></i> Apply for a Loan</h3>
            
            <div class="application-steps">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Personal Info</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Loan Details</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Collateral</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Next of Kin</div>
                </div>
                <div class="step" id="step5">
                    <div class="step-circle">5</div>
                    <div class="step-label">Review</div>
                </div>
            </div>
            
            <!-- Step 1: Personal Information -->
            <div id="step1-content" class="step-content">
                <div class="floating-form">
                    <div class="form-group">
                        <label class="form-label">Upload Profile Photo</label>
                        <div class="file-upload" id="profile-photo-upload" onclick="document.getElementById('profile-photo').click()">
                            <i class="fa-solid fa-cloud-upload-alt"></i>
                            <div class="file-upload-text">Click to upload</div>
                        </div>
                        <input type="file" id="profile-photo" accept="image/*" style="display: none;" onchange="handleFileUpload(this, 'profile-photo-upload')">
                        <div class="upload-progress" id="profile-photo-progress">
                            <div class="upload-progress-bar" id="profile-photo-progress-bar"></div>
                        </div>
                        <div class="error-message" id="profile-photo-error">Profile photo is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="full-name" placeholder="Enter your full name">
                        <div class="error-message" id="full-name-error">Full name is required</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="phone-number" placeholder="+260 XXX XXX XXX">
                            <div class="error-message" id="phone-number-error">Valid phone number is required</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="email" placeholder="your@email.com">
                            <div class="error-message" id="email-error">Valid email is required</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Date of Birth</label>
                        <input type="date" class="form-input" id="dob">
                        <div class="error-message" id="dob-error">Date of birth is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">National ID Number</label>
                        <input type="text" class="form-input" id="national-id" placeholder="Enter your national ID">
                        <div class="error-message" id="national-id-error">National ID is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" id="address" placeholder="Enter your address">
                        <div class="error-message" id="address-error">Address is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">City/Town</label>
                        <input type="text" class="form-input" id="city" placeholder="Enter your city">
                        <div class="error-message" id="city-error">City is required</div>
                    </div>
                    
                    <!-- NEW: Employment Information -->
                    <div class="form-group">
                        <label class="form-label">Employment Status</label>
                        <select class="form-select" id="employment-status">
                            <option value="">Select employment status</option>
                            <option value="employed">Employed</option>
                            <option value="self-employed">Self-Employed</option>
                            <option value="unemployed">Unemployed</option>
                            <option value="student">Student</option>
                            <option value="retired">Retired</option>
                        </select>
                        <div class="error-message" id="employment-status-error">Employment status is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Monthly Income (K)</label>
                        <input type="number" class="form-input" id="monthly-income" placeholder="Enter your monthly income">
                        <div class="error-message" id="monthly-income-error">Monthly income is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Employer Name</label>
                        <input type="text" class="form-input" id="employer-name" placeholder="Enter your employer name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Occupation</label>
                        <input type="text" class="form-input" id="occupation" placeholder="Enter your occupation">
                    </div>
                    
                    <!-- NEW: Bank Details -->
                    <div class="bank-details">
                        <h4>Bank Account Details</h4>
                        <div class="form-group">
                            <label class="form-label">Bank Name</label>
                            <input type="text" class="form-input" id="bank-name" placeholder="Enter your bank name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Number</label>
                            <input type="text" class="form-input" id="account-number" placeholder="Enter your account number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Branch Code</label>
                            <input type="text" class="form-input" id="branch-code" placeholder="Enter branch code">
                        </div>
                    </div>
                    
                    <div class="form-navigation">
                        <button class="btn-secondary" disabled>Previous</button>
                        <button class="btn-primary" onclick="validateStep(1)">Next</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Loan Details -->
            <div id="step2-content" class="step-content hidden">
                <div class="floating-form">
                    <div class="form-group">
                        <label class="form-label">Loan Amount</label>
                        <div class="amount-input-container">
                            <span class="currency-symbol">K</span>
                            <input type="number" class="amount-input" id="loan-amount-input" min="100" max="6000" value="2500" oninput="updateLoanAmount(this.value)">
                        </div>
                        <div style="text-align: center; margin-top: 6px; font-size: 12px; color: var(--text-light);">
                            Min: K100 - Max: K6,000
                        </div>
                        <div class="error-message" id="loan-amount-error">Valid loan amount is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Repayment Period</label>
                        <select class="form-select" id="repayment-period" onchange="calculateRepayment()">
                            <option value="7">1 Week</option>
                            <option value="14">2 Weeks</option>
                            <option value="21">3 Weeks</option>
                            <option value="30" selected>1 Month</option>
                            <option value="60">2 Months</option>
                        </select>
                    </div>
                    
                    <div class="repayment-summary">
                        <div class="summary-row">
                            <div>Loan Amount</div>
                            <div id="summary-amount">K2,500</div>
                        </div>
                        <div class="summary-row">
                            <div>Interest Rate</div>
                            <div id="summary-interest">35%</div>
                        </div>
                        <div class="summary-row">
                            <div>Interest Amount</div>
                            <div id="summary-interest-amount">K875</div>
                        </div>
                        <div class="summary-row">
                            <div>Processing Fee</div>
                            <div>K50</div>
                        </div>
                        <div class="summary-row summary-total">
                            <div>Total Repayment</div>
                            <div id="summary-total">K3,425</div>
                        </div>
                    </div>
                    
                    <div class="repayment-schedule">
                        <h4>Repayment Schedule</h4>
                        <div id="repayment-schedule-list">
                            <!-- Repayment schedule will be populated here -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Reason for Loan</label>
                        <textarea class="form-input" id="loan-reason" rows="3" placeholder="Explain why you need this loan"></textarea>
                        <div class="error-message" id="loan-reason-error">Loan reason is required</div>
                    </div>
                    
                    <!-- NEW: Loan Purpose Category -->
                    <div class="form-group">
                        <label class="form-label">Loan Purpose Category</label>
                        <div class="loan-purpose-grid">
                            <div class="purpose-item" data-value="education">
                                <div class="purpose-icon"><i class="fa-solid fa-graduation-cap"></i></div>
                                <div class="purpose-name">Education</div>
                            </div>
                            <div class="purpose-item" data-value="medical">
                                <div class="purpose-icon"><i class="fa-solid fa-heart-pulse"></i></div>
                                <div class="purpose-name">Medical</div>
                            </div>
                            <div class="purpose-item" data-value="business">
                                <div class="purpose-icon"><i class="fa-solid fa-briefcase"></i></div>
                                <div class="purpose-name">Business</div>
                            </div>
                            <div class="purpose-item" data-value="home">
                                <div class="purpose-icon"><i class="fa-solid fa-house"></i></div>
                                <div class="purpose-name">Home</div>
                            </div>
                            <div class="purpose-item" data-value="vehicle">
                                <div class="purpose-icon"><i class="fa-solid fa-car"></i></div>
                                <div class="purpose-name">Vehicle</div>
                            </div>
                            <div class="purpose-item" data-value="debt">
                                <div class="purpose-icon"><i class="fa-solid fa-money-bill-transfer"></i></div>
                                <div class="purpose-name">Debt</div>
                            </div>
                            <div class="purpose-item" data-value="emergency">
                                <div class="purpose-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
                                <div class="purpose-name">Emergency</div>
                            </div>
                            <div class="purpose-item" data-value="other">
                                <div class="purpose-icon"><i class="fa-solid fa-ellipsis"></i></div>
                                <div class="purpose-name">Other</div>
                            </div>
                        </div>
                        <div class="error-message" id="loan-purpose-error">Loan purpose is required</div>
                    </div>
                    
                    <div class="form-navigation">
                        <button class="btn-secondary" onclick="previousStep(1)">Previous</button>
                        <button class="btn-primary" onclick="validateStep(2)">Next</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Collateral Information -->
            <div id="step3-content" class="step-content hidden">
                <div class="floating-form">
                    <div class="form-group">
                        <label class="form-label">Choose Collateral Type</label>
                        <div class="collateral-grid" id="collateral-grid">
                            <div class="collateral-item" data-value="Cars">
                                <div class="collateral-icon"><i class="fa-solid fa-car"></i></div>
                                <div class="collateral-name">Cars</div>
                            </div>
                            <div class="collateral-item" data-value="Motorbikes">
                                <div class="collateral-icon"><i class="fa-solid fa-motorcycle"></i></div>
                                <div class="collateral-name">Motorbikes</div>
                            </div>
                            <div class="collateral-item" data-value="Laptops">
                                <div class="collateral-icon"><i class="fa-solid fa-laptop"></i></div>
                                <div class="collateral-name">Laptops</div>
                            </div>
                            <div class="collateral-item" data-value="Smartphones">
                                <div class="collateral-icon"><i class="fa-solid fa-mobile-screen"></i></div>
                                <div class="collateral-name">Smartphones</div>
                            </div>
                            <div class="collateral-item" data-value="Fridges">
                                <div class="collateral-icon"><i class="fa-solid fa-temperature-low"></i></div>
                                <div class="collateral-name">Fridges</div>
                            </div>
                            <div class="collateral-item" data-value="TVs">
                                <div class="collateral-icon"><i class="fa-solid fa-tv"></i></div>
                                <div class="collateral-name">TVs</div>
                            </div>
                            <div class="collateral-item" data-value="Sound systems">
                                <div class="collateral-icon"><i class="fa-solid fa-volume-high"></i></div>
                                <div class="collateral-name">Sound Systems</div>
                            </div>
                            <div class="collateral-item" data-value="Game consoles">
                                <div class="collateral-icon"><i class="fa-solid fa-gamepad"></i></div>
                                <div class="collateral-name">Game Consoles</div>
                            </div>
                        </div>
                        <div class="error-message" id="collateral-type-error">Collateral type is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description of Collateral</label>
                        <textarea class="form-input" id="collateral-description" rows="3" placeholder="Describe your collateral in detail (brand, model, condition, etc.)"></textarea>
                        <div class="error-message" id="collateral-description-error">Collateral description is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Estimated Value (K)</label>
                        <input type="number" class="form-input" id="collateral-value" placeholder="Estimated value of collateral">
                        <div class="error-message" id="collateral-value-error">Collateral value is required</div>
                    </div>
                    
                    <div class="document-checklist">
                        <h4>Required Documents</h4>
                        <div class="checklist-item">
                            <i class="fa-solid fa-id-card"></i>
                            <span>National ID (Front & Back)</span>
                        </div>
                        <div class="checklist-item">
                            <i class="fa-solid fa-camera"></i>
                            <span>Collateral Photos (Multiple Angles)</span>
                        </div>
                        <div class="checklist-item">
                            <i class="fa-solid fa-file-contract"></i>
                            <span>Proof of Ownership (Optional)</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Upload NRC Front</label>
                        <div class="doc-upload" id="nrc-front-upload" onclick="document.getElementById('nrc-front').click()">
                            <i class="fa-solid fa-id-card"></i>
                            <div class="doc-upload-text">Click to upload NRC front</div>
                        </div>
                        <input type="file" id="nrc-front" accept="image/*" style="display: none;" onchange="handleFileUpload(this, 'nrc-front-upload')">
                        <div class="upload-progress" id="nrc-front-progress">
                            <div class="upload-progress-bar" id="nrc-front-progress-bar"></div>
                        </div>
                        <div class="error-message" id="nrc-front-error">NRC front photo is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Upload NRC Back</label>
                        <div class="doc-upload" id="nrc-back-upload" onclick="document.getElementById('nrc-back').click()">
                            <i class="fa-solid fa-id-card"></i>
                            <div class="doc-upload-text">Click to upload NRC back</div>
                        </div>
                        <input type="file" id="nrc-back" accept="image/*" style="display: none;" onchange="handleFileUpload(this, 'nrc-back-upload')">
                        <div class="upload-progress" id="nrc-back-progress">
                            <div class="upload-progress-bar" id="nrc-back-progress-bar"></div>
                        </div>
                        <div class="error-message" id="nrc-back-error">NRC back photo is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Upload Collateral Photos</label>
                        <div class="doc-row">
                            <div class="doc-item">
                                <div class="doc-upload" id="collateral-front-upload" onclick="document.getElementById('collateral-front').click()">
                                    <i class="fa-solid fa-camera"></i>
                                    <div class="doc-upload-text">Front View</div>
                                </div>
                                <input type="file" id="collateral-front" accept="image/*" style="display: none;" onchange="handleFileUpload(this, 'collateral-front-upload')">
                                <div class="upload-progress" id="collateral-front-progress">
                                    <div class="upload-progress-bar" id="collateral-front-progress-bar"></div>
                                </div>
                            </div>
                            <div class="doc-item">
                                <div class="doc-upload" id="collateral-back-upload" onclick="document.getElementById('collateral-back').click()">
                                    <i class="fa-solid fa-camera"></i>
                                    <div class="doc-upload-text">Back View</div>
                                </div>
                                <input type="file" id="collateral-back" accept="image/*" style="display: none;" onchange="handleFileUpload(this, 'collateral-back-upload')">
                                <div class="upload-progress" id="collateral-back-progress">
                                    <div class="upload-progress-bar" id="collateral-back-progress-bar"></div>
                                </div>
                            </div>
                        </div>
                        <div class="doc-row">
                            <div class="doc-item">
                                <div class="doc-upload" id="collateral-left-upload" onclick="document.getElementById('collateral-left').click()">
                                    <i class="fa-solid fa-camera"></i>
                                    <div class="doc-upload-text">Left Side</div>
                                </div>
                                <input type="file" id="collateral-left" accept="image/*" style="display: none;" onchange="handleFileUpload(this, 'collateral-left-upload')">
                                <div class="upload-progress" id="collateral-left-progress">
                                    <div class="upload-progress-bar" id="collateral-left-progress-bar"></div>
                                </div>
                            </div>
                            <div class="doc-item">
                                <div class="doc-upload" id="collateral-right-upload" onclick="document.getElementById('collateral-right').click()">
                                    <i class="fa-solid fa-camera"></i>
                                    <div class="doc-upload-text">Right Side</div>
                                </div>
                                <input type="file" id="collateral-right" accept="image/*" style="display: none;" onchange="handleFileUpload(this, 'collateral-right-upload')">
                                <div class="upload-progress" id="collateral-right-progress">
                                    <div class="upload-progress-bar" id="collateral-right-progress-bar"></div>
                                </div>
                            </div>
                        </div>
                        <div class="error-message" id="collateral-photos-error">At least one collateral photo is required</div>
                    </div>
                    
                    <!-- NEW: Proof of Ownership -->
                    <div class="form-group">
                        <label class="form-label">Proof of Ownership (Optional)</label>
                        <div class="doc-upload" id="ownership-proof-upload" onclick="document.getElementById('ownership-proof').click()">
                            <i class="fa-solid fa-file-contract"></i>
                            <div class="doc-upload-text">Click to upload proof of ownership</div>
                        </div>
                        <input type="file" id="ownership-proof" accept="image/*,.pdf" style="display: none;" onchange="handleFileUpload(this, 'ownership-proof-upload')">
                        <div class="upload-progress" id="ownership-proof-progress">
                            <div class="upload-progress-bar" id="ownership-proof-progress-bar"></div>
                        </div>
                    </div>
                    
                    <!-- NEW: Additional Documents -->
                    <div class="additional-docs">
                        <h4>Additional Documents (Optional)</h4>
                        <div class="form-group">
                            <label class="form-label">Proof of Income</label>
                            <div class="doc-upload" id="income-proof-upload" onclick="document.getElementById('income-proof').click()">
                                <i class="fa-solid fa-file-invoice-dollar"></i>
                                <div class="doc-upload-text">Click to upload proof of income</div>
                            </div>
                            <input type="file" id="income-proof" accept="image/*,.pdf" style="display: none;" onchange="handleFileUpload(this, 'income-proof-upload')">
                            <div class="upload-progress" id="income-proof-progress">
                                <div class="upload-progress-bar" id="income-proof-progress-bar"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Utility Bill (Proof of Address)</label>
                            <div class="doc-upload" id="utility-bill-upload" onclick="document.getElementById('utility-bill').click()">
                                <i class="fa-solid fa-file-invoice"></i>
                                <div class="doc-upload-text">Click to upload utility bill</div>
                            </div>
                            <input type="file" id="utility-bill" accept="image/*,.pdf" style="display: none;" onchange="handleFileUpload(this, 'utility-bill-upload')">
                            <div class="upload-progress" id="utility-bill-progress">
                                <div class="upload-progress-bar" id="utility-bill-progress-bar"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-navigation">
                        <button class="btn-secondary" onclick="previousStep(2)">Previous</button>
                        <button class="btn-primary" onclick="validateStep(3)">Next</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Next of Kin & Guarantor -->
            <div id="step4-content" class="step-content hidden">
                <div class="floating-form">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="kin-name" placeholder="Next of kin's full name">
                        <div class="error-message" id="kin-name-error">Next of kin name is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Relationship</label>
                        <select class="form-select" id="kin-relationship">
                            <option value="">Select relationship</option>
                            <option>Spouse</option>
                            <option>Parent</option>
                            <option>Sibling</option>
                            <option>Child</option>
                            <option>Other Relative</option>
                            <option>Friend</option>
                        </select>
                        <div class="error-message" id="kin-relationship-error">Relationship is required</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="kin-phone" placeholder="+260 XXX XXX XXX">
                            <div class="error-message" id="kin-phone-error">Valid phone number is required</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="kin-email" placeholder="kin@email.com">
                            <div class="error-message" id="kin-email-error">Valid email is required</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" id="kin-address" placeholder="Next of kin's address">
                        <div class="error-message" id="kin-address-error">Address is required</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Upload Next of Kin ID (Optional)</label>
                        <div class="doc-upload" id="kin-id-upload" onclick="document.getElementById('kin-id').click()">
                            <i class="fa-solid fa-id-card"></i>
                            <div class="doc-upload-text">Click to upload ID</div>
                        </div>
                        <input type="file" id="kin-id" accept="image/*" style="display: none;" onchange="handleFileUpload(this, 'kin-id-upload')">
                        <div class="upload-progress" id="kin-id-progress">
                            <div class="upload-progress-bar" id="kin-id-progress-bar"></div>
                        </div>
                    </div>
                    
                    <!-- NEW: Guarantor Section -->
                    <div class="guarantor-section">
                        <h4>Guarantor Information (Optional)</h4>
                        <div class="form-group">
                            <label class="form-label">Guarantor Full Name</label>
                            <input type="text" class="form-input" id="guarantor-name" placeholder="Guarantor's full name">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Guarantor Relationship</label>
                            <select class="form-select" id="guarantor-relationship">
                                <option value="">Select relationship</option>
                                <option>Spouse</option>
                                <option>Parent</option>
                                <option>Sibling</option>
                                <option>Friend</option>
                                <option>Colleague</option>
                                <option>Other</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Guarantor Phone</label>
                                <input type="tel" class="form-input" id="guarantor-phone" placeholder="+260 XXX XXX XXX">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Guarantor Email</label>
                                <input type="email" class="form-input" id="guarantor-email" placeholder="guarantor@email.com">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Guarantor Address</label>
                            <input type="text" class="form-input" id="guarantor-address" placeholder="Guarantor's address">
                        </div>
                    </div>
                    
                    <div class="form-navigation">
                        <button class="btn-secondary" onclick="previousStep(3)">Previous</button>
                        <button class="btn-primary" onclick="validateStep(4)">Next</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 5: Review and Submit -->
            <div id="step5-content" class="step-content hidden">
                <div class="floating-form">
                    <h3 style="margin-top: 0;">Review Your Application</h3>
                    
                    <div class="application-summary">
                        <div class="summary-section">
                            <div class="summary-section-title">Personal Information</div>
                            <div class="summary-item">
                                <div class="summary-item-label">Name:</div>
                                <div class="summary-item-value" id="review-name">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Phone:</div>
                                <div class="summary-item-value" id="review-phone">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Email:</div>
                                <div class="summary-item-value" id="review-email">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Date of Birth:</div>
                                <div class="summary-item-value" id="review-dob">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">National ID:</div>
                                <div class="summary-item-value" id="review-national-id">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Address:</div>
                                <div class="summary-item-value" id="review-address">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">City:</div>
                                <div class="summary-item-value" id="review-city">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Employment Status:</div>
                                <div class="summary-item-value" id="review-employment">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Monthly Income:</div>
                                <div class="summary-item-value" id="review-income">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Employer:</div>
                                <div class="summary-item-value" id="review-employer">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Occupation:</div>
                                <div class="summary-item-value" id="review-occupation">-</div>
                            </div>
                        </div>
                        
                        <div class="summary-section">
                            <div class="summary-section-title">Loan Details</div>
                            <div class="summary-item">
                                <div class="summary-item-label">Amount:</div>
                                <div class="summary-item-value" id="review-loan-amount">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Term:</div>
                                <div class="summary-item-value" id="review-term">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Interest Rate:</div>
                                <div class="summary-item-value" id="review-interest">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Total Repayment:</div>
                                <div class="summary-item-value" id="review-total">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Reason:</div>
                                <div class="summary-item-value" id="review-reason">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Purpose:</div>
                                <div class="summary-item-value" id="review-purpose">-</div>
                            </div>
                        </div>
                        
                        <div class="summary-section">
                            <div class="summary-section-title">Collateral Information</div>
                            <div class="summary-item">
                                <div class="summary-item-label">Type:</div>
                                <div class="summary-item-value" id="review-collateral">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Description:</div>
                                <div class="summary-item-value" id="review-collateral-desc">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Estimated Value:</div>
                                <div class="summary-item-value" id="review-collateral-value">-</div>
                            </div>
                        </div>
                        
                        <div class="summary-section">
                            <div class="summary-section-title">Next of Kin</div>
                            <div class="summary-item">
                                <div class="summary-item-label">Name:</div>
                                <div class="summary-item-value" id="review-kin-name">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Relationship:</div>
                                <div class="summary-item-value" id="review-kin-relationship">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Phone:</div>
                                <div class="summary-item-value" id="review-kin-phone">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Email:</div>
                                <div class="summary-item-value" id="review-kin-email">-</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-item-label">Address:</div>
                                <div class="summary-item-value" id="review-kin-address">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="application-fee">
                        <div class="fee-amount">K50 Application Fee</div>
                        <div>This fee will be deducted from your loan amount upon approval</div>
                    </div>
                    
                    <div class="application-tips">
                        <div class="tip-item">
                            <div class="tip-icon"><i class="fa-solid fa-lightbulb"></i></div>
                            <div class="tip-content">Ensure all information provided is accurate to avoid delays in processing</div>
                        </div>
                        <div class="tip-item">
                            <div class="tip-icon"><i class="fa-solid fa-lightbulb"></i></div>
                            <div class="tip-content">Your application will be processed within 24-48 hours</div>
                        </div>
                        <div class="tip-item">
                            <div class="tip-icon"><i class="fa-solid fa-lightbulb"></i></div>
                            <div class="tip-content">You will receive notifications about your application status</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <input type="checkbox" id="agree-terms" style="margin-top: 3px;">
                            <label for="agree-terms" style="font-size: 13px;">
                                I agree to the <a href="#" style="color: var(--primary);" onclick="showTermsModal()">Terms and Conditions</a> and confirm that all information provided is accurate.
                            </label>
                        </div>
                        <div class="error-message" id="agree-terms-error">You must agree to the terms and conditions</div>
                    </div>
                    
                    <div class="form-navigation">
                        <button class="btn-secondary" onclick="previousStep(4)">Previous</button>
                        <button class="btn-primary" id="submit-btn" onclick="submitApplication()">Submit Application</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payments Page -->
        <div id="payments-page" class="page hidden">
            <h3 class="section-title"><i class="fa-solid fa-credit-card"></i> Payments</h3>
            
            <div class="payment-card">
                <h4>Make a Payment</h4>
                <div class="form-group">
                    <label class="form-label">Select Loan</label>
                    <select class="form-select" id="payment-loan-select">
                        <option value="">Select a loan to pay</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Payment Amount (K)</label>
                    <input type="number" class="form-input" id="payment-amount" placeholder="Enter amount">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <div class="payment-methods">
                        <div class="payment-method" data-method="mobile-money">
                            <i class="fa-solid fa-mobile-screen"></i>
                            <div class="payment-method-name">Mobile Money</div>
                        </div>
                        <div class="payment-method" data-method="bank-transfer">
                            <i class="fa-solid fa-building-columns"></i>
                            <div class="payment-method-name">Bank Transfer</div>
                        </div>
                        <div class="payment-method" data-method="cash">
                            <i class="fa-solid fa-money-bill"></i>
                            <div class="payment-method-name">Cash</div>
                        </div>
                    </div>
                </div>
                
                <button class="apply-btn" id="make-payment-btn">Make Payment</button>
            </div>
            
            <h3 class="section-title"><i class="fa-solid fa-clock-rotate-left"></i> Payment History</h3>
            
            <div id="payment-history-container">
                <div class="empty-state">
                    <i class="fa-solid fa-receipt"></i>
                    <p>No payment history</p>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="page hidden">
            <h3 class="section-title"><i class="fa-solid fa-user"></i> My Profile</h3>
            
            <div class="floating-form">
                <div style="text-align: center; padding: 16px;">
                    <div style="width: 80px; height: 80px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 14px; color: var(--primary); font-size: 28px; box-shadow: var(--shadow);">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div style="font-weight: 600; font-size: 16px;" id="profile-name">John Doe</div>
                    <div style="font-size: 13px; color: var(--text-light); margin-top: 3px;" id="profile-phone">+260 123 456 789</div>
                </div>
                
                <div style="border-top: 1px solid var(--grey); padding-top: 16px;">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="profile-name-input" value="John Doe">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="text" class="form-input" id="profile-phone-input" value="+260 123 456 789">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="profile-email-input" value="johndoe@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Date of Birth</label>
                        <input type="date" class="form-input" id="profile-dob-input" value="1990-01-01">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">National ID</label>
                        <input type="text" class="form-input" id="profile-id-input" value="123456/78/9">
                    </div>
                    
                    <button class="apply-btn" id="update-profile-btn">Update Profile</button>
                </div>
            </div>
            
            <div class="referral-code">
                <div>
                    <div style="font-size: 13px; font-weight: 500;">Your Referral Code</div>
                    <div class="referral-code-text" id="referral-code">DMK-5A8B2C</div>
                </div>
                <button class="copy-btn" onclick="copyReferralCode()">Copy</button>
            </div>
            
            <!-- NEW: Credit Score Display -->
            <div class="credit-score-display">
                <div class="score-circle">
                    <div class="score-value" id="credit-score-value">720</div>
                </div>
                <div class="score-label">Your Credit Score</div>
            </div>
            
            <!-- NEW: Application Security -->
            <div class="application-security">
                <div class="security-icon">
                    <i class="fa-solid fa-shield-halved"></i>
                </div>
                <div class="security-title">Your Information is Secure</div>
                <div class="security-text">We use bank-level encryption to protect your personal and financial data</div>
            </div>
        </div>
    </main>

    <button class="floating-btn" onclick="showPage('apply-page')">
        <i class="fa-solid fa-plus"></i>
    </button>

    <nav>
        <button class="nav-item active" onclick="showPage('home-page')">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="showPage('loans-page')">
            <i class="fa-solid fa-hand-holding-dollar"></i>
            <span>Loans</span>
        </button>
        <button class="nav-item" onclick="showPage('apply-page')">
            <i class="fa-solid fa-paper-plane"></i>
            <span>Apply</span>
        </button>
        <button class="nav-item" onclick="showPage('payments-page')">
            <i class="fa-solid fa-credit-card"></i>
            <span>Payments</span>
        </button>
        <button class="nav-item" onclick="showPage('profile-page')">
            <i class="fa-solid fa-user"></i>
            <span>Profile</span>
        </button>
    </nav>

    <!-- Side Panel -->
    <div class="side-panel" id="side-panel">
        <div class="panel-header">
            <h2>Menu</h2>
            <button class="close-panel" id="close-panel">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="panel-item" onclick="showPage('profile-page'); closePanel()">
                <i class="fa-solid fa-user"></i>
                <span>Profile</span>
            </div>
            <div class="panel-item" onclick="showPage('payments-page'); closePanel()">
                <i class="fa-solid fa-credit-card"></i>
                <span>Payments</span>
            </div>
            <div class="panel-item" onclick="showTermsModal(); closePanel()">
                <i class="fa-solid fa-file-contract"></i>
                <span>Terms & Conditions</span>
            </div>
            <div class="panel-item" onclick="closePanel()">
                <i class="fa-solid fa-question-circle"></i>
                <span>Help & Support</span>
            </div>
            <div class="panel-item" onclick="showReferralSection(); closePanel()">
                <i class="fa-solid fa-share-alt"></i>
                <span>Refer a Friend</span>
            </div>
            <div class="panel-item" onclick="closePanel()">
                <i class="fa-solid fa-cog"></i>
                <span>Settings</span>
            </div>
            <div class="panel-item" onclick="logout(); closePanel()">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Logout</span>
            </div>
        </div>
    </div>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notification-panel">
        <div class="panel-header">
            <h2>Notifications</h2>
            <button class="close-panel" id="close-notification-panel">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div class="panel-content" id="notification-list">
            <!-- Notifications will be populated here -->
        </div>
    </div>

    <!-- Terms and Conditions Modal -->
    <div class="terms-modal" id="terms-modal">
        <div class="modal-header">
            <div class="modal-title">Terms and Conditions</div>
            <button class="close-modal" id="close-terms-modal">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
            <p>By applying for a loan with DMK Money Solution, you agree to the following terms and conditions:</p>
            
            <h4>1. Loan Agreement</h4>
            <p>You understand that this is a legally binding agreement and you are responsible for repaying the loan amount plus interest and fees according to the agreed schedule.</p>
            
            <h4>2. Interest Rates and Fees</h4>
            <p>Interest rates range from 20% to 50% depending on the loan term. A K50 processing fee applies to all loans.</p>
            
            <h4>3. Repayment</h4>
            <p>You agree to make timely repayments as per the schedule. Late payments may incur additional fees and affect your credit score.</p>
            
            <h4>4. Collateral</h4>
            <p>You understand that the collateral provided may be seized in case of default on loan repayment.</p>
            
            <h4>5. Data Privacy</h4>
            <p>We collect and process your personal information in accordance with our privacy policy and applicable data protection laws.</p>
            
            <h4>6. Credit Assessment</h4>
            <p>You consent to us conducting credit checks and assessments as part of the loan application process.</p>
            
            <p>By proceeding with your application, you confirm that you have read, understood, and agree to these terms and conditions.</p>
        </div>
    </div>

    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="overlay" id="overlay"></div>

    <script>
       // Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyCzf9dZFB0l7ZEPLJ4tpo4bSjgQNW3VTus",
    authDomain: "dmkl-8ea2c.firebaseapp.com",
    databaseURL: "https://dmkl-8ea2c-default-rtdb.firebaseio.com",
    projectId: "dmkl-8ea2c",
    storageBucket: "dmkl-8ea2c.firebasestorage.app",
    messagingSenderId: "155892504799",
    appId: "1:155892504799:web:45ed0037fd0fe79b85b16a",
    measurementId: "G-61M65C4MZ2"
};

// Initialize Firebase
try {
    firebase.initializeApp(firebaseConfig);
} catch (error) {
    console.log("Firebase already initialized");
}

const db = firebase.firestore();
const storage = firebase.storage();
const auth = firebase.auth();
const realtimeDb = firebase.database();

// Enable offline persistence for Firestore
db.enablePersistence()
  .catch((err) => {
      if (err.code == 'failed-precondition') {
          console.log("Multiple tabs open, persistence can only be enabled in one tab at a time.");
      } else if (err.code == 'unimplemented') {
          console.log("The current browser doesn't support persistence");
      }
  });

// Application state
let currentUser = null;
let currentStep = 1;
let applicationData = {
    personalInfo: {},
    loanDetails: {},
    collateralInfo: {},
    nextOfKin: {},
    guarantor: {},
    documents: {}
};
let uploadedFiles = {};
let notifications = [];
let userLoans = [];
let userPayments = [];
let userStats = {
    totalLoans: 0,
    activeLoans: 0,
    creditScore: 720,
    referralEarnings: 0,
    nextPayment: 0,
    dueDate: '-',
    interestRate: '0%',
    availableLimit: 6000
};

// Real-time listeners
let loansListener = null;
let paymentsListener = null;
let notificationsListener = null;
let userStatsListener = null;

// Check authentication state
auth.onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        showPage('home-page');
        setupRealtimeListeners();
        loadUserData();
    } else {
        currentUser = null;
        cleanupRealtimeListeners();
        showPage('auth-page');
    }
});

// Setup real-time listeners
function setupRealtimeListeners() {
    if (!currentUser) return;

    // Real-time loans listener
    loansListener = db.collection('applications')
        .where('userId', '==', currentUser.uid)
        .orderBy('submittedAt', 'desc')
        .onSnapshot((snapshot) => {
            const loans = [];
            snapshot.forEach(doc => {
                loans.push({ id: doc.id, ...doc.data() });
            });
            userLoans = loans;
            updateLoansDisplay();
            updateUserStats();
        }, (error) => {
            console.error('Error listening to loans:', error);
        });

    // Real-time payments listener
    paymentsListener = db.collection('payments')
        .where('userId', '==', currentUser.uid)
        .orderBy('paymentDate', 'desc')
        .onSnapshot((snapshot) => {
            const payments = [];
            snapshot.forEach(doc => {
                payments.push({ id: doc.id, ...doc.data() });
            });
            userPayments = payments;
            updatePaymentsDisplay();
        }, (error) => {
            console.error('Error listening to payments:', error);
        });

    // Real-time notifications listener
    notificationsListener = db.collection('notifications')
        .where('userId', '==', currentUser.uid)
        .where('read', '==', false)
        .orderBy('createdAt', 'desc')
        .onSnapshot((snapshot) => {
            notifications = [];
            snapshot.forEach(doc => {
                notifications.push({ id: doc.id, ...doc.data() });
            });
            updateNotificationBadge();
            updateNotificationList();
        }, (error) => {
            console.error('Error listening to notifications:', error);
        });

    // Real-time user stats listener
    userStatsListener = db.collection('userStats')
        .doc(currentUser.uid)
        .onSnapshot((doc) => {
            if (doc.exists) {
                userStats = doc.data();
                updateDashboardWidgets();
            }
        }, (error) => {
            console.error('Error listening to user stats:', error);
        });
}

// Cleanup real-time listeners
function cleanupRealtimeListeners() {
    if (loansListener) loansListener();
    if (paymentsListener) paymentsListener();
    if (notificationsListener) notificationsListener();
    if (userStatsListener) userStatsListener();
}

// Monitor connection status
firebase.firestore().enableNetwork()
  .then(() => {
      document.getElementById('offline-indicator').classList.remove('show');
  })
  .catch((error) => {
      console.log("Error enabling network:", error);
  });

// Listen for connection state changes
firebase.firestore().onSnapshotsInSync(() => {
    document.getElementById('offline-indicator').classList.remove('show');
});

// Authentication functions
function login() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    if (!email || !password) {
        showToast('Please enter both email and password', 'error');
        return;
    }
    
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            showToast('Login successful!', 'success');
        })
        .catch((error) => {
            console.error('Login error:', error);
            showToast('Login failed: ' + error.message, 'error');
        });
}

function signup() {
    const name = document.getElementById('signup-name').value;
    const email = document.getElementById('signup-email').value;
    const phone = document.getElementById('signup-phone').value;
    const password = document.getElementById('signup-password').value;
    
    if (!name || !email || !phone || !password) {
        showToast('Please fill all fields', 'error');
        return;
    }
    
    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            
            // Create user profile in Firestore
            return db.collection('users').doc(user.uid).set({
                name: name,
                email: email,
                phone: phone,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                referralCode: generateReferralCode(),
                creditScore: 650,
                employmentStatus: '',
                monthlyIncome: 0,
                employerName: '',
                occupation: '',
                bankName: '',
                accountNumber: '',
                branchCode: '',
                totalLoans: 0,
                activeLoans: 0,
                referralEarnings: 0
            });
        })
        .then(() => {
            showToast('Account created successfully!', 'success');
        })
        .catch((error) => {
            console.error('Signup error:', error);
            showToast('Signup failed: ' + error.message, 'error');
        });
}

function logout() {
    auth.signOut()
        .then(() => {
            showToast('Logged out successfully', 'success');
        })
        .catch((error) => {
            console.error('Logout error:', error);
        });
}

function generateReferralCode() {
    return 'DMK-' + Math.random().toString(36).substring(2, 8).toUpperCase();
}

// Page navigation
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => {
        page.classList.add('hidden');
    });
    
    document.getElementById(pageId).classList.remove('hidden');
    
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    if (pageId === 'home-page') {
        document.querySelectorAll('.nav-item')[0].classList.add('active');
        updateDashboardWidgets();
    } else if (pageId === 'loans-page') {
        document.querySelectorAll('.nav-item')[1].classList.add('active');
        updateLoansDisplay();
    } else if (pageId === 'apply-page') {
        document.querySelectorAll('.nav-item')[2].classList.add('active');
        resetApplicationForm();
    } else if (pageId === 'payments-page') {
        document.querySelectorAll('.nav-item')[3].classList.add('active');
        updatePaymentsDisplay();
    } else if (pageId === 'profile-page') {
        document.querySelectorAll('.nav-item')[4].classList.add('active');
        loadUserProfile();
    } else if (pageId === 'auth-page') {
        document.querySelector('nav').style.display = 'none';
        document.querySelector('.floating-btn').style.display = 'none';
    } else {
        document.querySelector('nav').style.display = 'flex';
        document.querySelector('.floating-btn').style.display = 'flex';
    }
}

// Auth tabs
document.getElementById('login-tab').addEventListener('click', function() {
    document.getElementById('login-tab').classList.add('active');
    document.getElementById('signup-tab').classList.remove('active');
    document.getElementById('login-form').classList.remove('hidden');
    document.getElementById('signup-form').classList.add('hidden');
});

document.getElementById('signup-tab').addEventListener('click', function() {
    document.getElementById('signup-tab').classList.add('active');
    document.getElementById('login-tab').classList.remove('active');
    document.getElementById('signup-form').classList.remove('hidden');
    document.getElementById('login-form').classList.add('hidden');
});

// Side panel functionality
document.getElementById('menu-toggle').addEventListener('click', function() {
    document.getElementById('side-panel').classList.add('open');
    document.getElementById('overlay').classList.add('active');
});

document.getElementById('close-panel').addEventListener('click', closePanel);
document.getElementById('overlay').addEventListener('click', closePanel);

function closePanel() {
    document.getElementById('side-panel').classList.remove('open');
    document.getElementById('notification-panel').classList.remove('open');
    document.getElementById('overlay').classList.remove('active');
}

// Notification panel
document.getElementById('notification-toggle').addEventListener('click', function() {
    document.getElementById('notification-panel').classList.add('open');
    document.getElementById('overlay').classList.add('active');
});

document.getElementById('close-notification-panel').addEventListener('click', function() {
    document.getElementById('notification-panel').classList.remove('open');
    document.getElementById('overlay').classList.remove('active');
});

// Terms modal
document.getElementById('close-terms-modal').addEventListener('click', closeTermsModal);
document.getElementById('modal-overlay').addEventListener('click', closeTermsModal);

function showTermsModal() {
    document.getElementById('terms-modal').classList.add('show');
    document.getElementById('modal-overlay').classList.add('active');
}

function closeTermsModal() {
    document.getElementById('terms-modal').classList.remove('show');
    document.getElementById('modal-overlay').classList.remove('active');
}

// Multi-step application form
function nextStep(step) {
    document.getElementById('step' + currentStep + '-content').classList.add('hidden');
    document.getElementById('step' + currentStep).classList.remove('active');
    
    currentStep = step;
    
    document.getElementById('step' + currentStep + '-content').classList.remove('hidden');
    document.getElementById('step' + currentStep).classList.add('active');
    
    if (step === 5) {
        updateReviewSection();
    }
}

function previousStep(step) {
    document.getElementById('step' + currentStep + '-content').classList.add('hidden');
    document.getElementById('step' + currentStep).classList.remove('active');
    
    currentStep = step;
    
    document.getElementById('step' + currentStep + '-content').classList.remove('hidden');
    document.getElementById('step' + currentStep).classList.add('active');
}

function resetApplicationForm() {
    currentStep = 1;
    document.querySelectorAll('.step-content').forEach(step => {
        step.classList.add('hidden');
    });
    document.getElementById('step1-content').classList.remove('hidden');
    
    document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
    });
    document.getElementById('step1').classList.add('active');
    
    applicationData = {
        personalInfo: {},
        loanDetails: {},
        collateralInfo: {},
        nextOfKin: {},
        guarantor: {},
        documents: {}
    };
    uploadedFiles = {};
    
    document.querySelectorAll('.file-upload, .doc-upload').forEach(upload => {
        upload.innerHTML = '<i class="fa-solid fa-cloud-upload-alt"></i><div class="file-upload-text">Click to upload</div>';
        upload.classList.remove('has-image');
    });
    
    document.querySelectorAll('.form-input, .form-select').forEach(field => {
        if (field.id !== 'loan-amount-input') {
            field.value = '';
        }
        field.classList.remove('error');
    });
    
    document.querySelectorAll('.collateral-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    document.querySelectorAll('.purpose-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    document.querySelectorAll('.error-message').forEach(error => {
        error.style.display = 'none';
    });
    
    document.getElementById('loan-amount-input').value = '2500';
    calculateRepayment();
}

// Collateral selection
document.querySelectorAll('.collateral-item').forEach(item => {
    item.addEventListener('click', function() {
        document.querySelectorAll('.collateral-item').forEach(i => {
            i.classList.remove('selected');
        });
        this.classList.add('selected');
        
        applicationData.collateralInfo['collateral-type'] = this.getAttribute('data-value');
        document.getElementById('collateral-type-error').style.display = 'none';
    });
});

// Purpose selection
document.querySelectorAll('.purpose-item').forEach(item => {
    item.addEventListener('click', function() {
        document.querySelectorAll('.purpose-item').forEach(i => {
            i.classList.remove('selected');
        });
        this.classList.add('selected');
        
        applicationData.loanDetails['loan-purpose'] = this.getAttribute('data-value');
        document.getElementById('loan-purpose-error').style.display = 'none';
    });
});

// Payment method selection
document.querySelectorAll('.payment-method').forEach(method => {
    method.addEventListener('click', function() {
        document.querySelectorAll('.payment-method').forEach(m => {
            m.classList.remove('selected');
        });
        this.classList.add('selected');
    });
});

// Form validation
function validateField(fieldId, type) {
    const field = document.getElementById(fieldId);
    const value = field.value.trim();
    const errorId = fieldId + '-error';
    const errorElement = document.getElementById(errorId);
    
    if (!errorElement) return true;
    
    let isValid = true;
    let errorMessage = '';
    
    switch(type) {
        case 'name':
            if (value.length < 2) {
                isValid = false;
                errorMessage = 'Please enter a valid name';
            }
            break;
        case 'phone':
            const phoneRegex = /^\+?[\d\s-]{10,}$/;
            if (!phoneRegex.test(value)) {
                isValid = false;
                errorMessage = 'Please enter a valid phone number';
            }
            break;
        case 'email':
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                isValid = false;
                errorMessage = 'Please enter a valid email address';
            }
            break;
        case 'address':
            if (value.length < 5) {
                isValid = false;
                errorMessage = 'Please enter a valid address';
            }
            break;
        case 'select':
            if (!value) {
                isValid = false;
                errorMessage = 'This field is required';
            }
            break;
        case 'text':
            if (value.length < 10) {
                isValid = false;
                errorMessage = 'Please provide more details';
            }
            break;
        case 'amount':
            const amount = parseInt(value);
            if (isNaN(amount) || amount < 100 || amount > 6000) {
                isValid = false;
                errorMessage = 'Please enter a valid amount between K100 and K6,000';
            }
            break;
        case 'date':
            if (!value) {
                isValid = false;
                errorMessage = 'This field is required';
            }
            break;
        case 'id':
            if (value.length < 5) {
                isValid = false;
                errorMessage = 'Please enter a valid ID number';
            }
            break;
        case 'income':
            const income = parseInt(value);
            if (isNaN(income) || income < 0) {
                isValid = false;
                errorMessage = 'Please enter a valid income amount';
            }
            break;
    }
    
    if (isValid) {
        field.classList.remove('error');
        errorElement.style.display = 'none';
        
        const fieldCategory = getFieldCategory(fieldId);
        if (fieldCategory) {
            applicationData[fieldCategory][fieldId] = value;
        }
    } else {
        field.classList.add('error');
        errorElement.textContent = errorMessage;
        errorElement.style.display = 'block';
    }
    
    return isValid;
}

function getFieldCategory(fieldId) {
    if (fieldId.includes('kin-')) {
        return 'nextOfKin';
    } else if (fieldId.includes('guarantor-')) {
        return 'guarantor';
    } else if (fieldId.includes('loan-') || fieldId === 'repayment-period' || fieldId === 'loan-reason' || fieldId === 'loan-purpose') {
        return 'loanDetails';
    } else if (fieldId.includes('collateral-')) {
        return 'collateralInfo';
    } else if (fieldId.includes('employment-') || fieldId.includes('monthly-income') || fieldId.includes('employer-') || fieldId === 'occupation' || 
              fieldId.includes('bank-') || fieldId.includes('account-') || fieldId.includes('branch-')) {
        return 'personalInfo';
    } else {
        return 'personalInfo';
    }
}

function validateStep(step) {
    let isValid = true;
    
    switch(step) {
        case 1:
            const step1Fields = [
                { id: 'full-name', type: 'name' },
                { id: 'phone-number', type: 'phone' },
                { id: 'email', type: 'email' },
                { id: 'dob', type: 'date' },
                { id: 'national-id', type: 'id' },
                { id: 'address', type: 'address' },
                { id: 'city', type: 'name' },
                { id: 'employment-status', type: 'select' },
                { id: 'monthly-income', type: 'income' }
            ];
            
            step1Fields.forEach(field => {
                if (!validateField(field.id, field.type)) {
                    isValid = false;
                }
            });
            
            const profileUpload = document.getElementById('profile-photo-upload');
            if (!profileUpload.classList.contains('has-image')) {
                document.getElementById('profile-photo-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('profile-photo-error').style.display = 'none';
            }
            
            break;
            
        case 2:
            const step2Fields = [
                { id: 'loan-amount-input', type: 'amount' },
                { id: 'loan-reason', type: 'text' }
            ];
            
            step2Fields.forEach(field => {
                if (!validateField(field.id, field.type)) {
                    isValid = false;
                }
            });
            
            if (!applicationData.loanDetails['loan-purpose']) {
                document.getElementById('loan-purpose-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('loan-purpose-error').style.display = 'none';
            }
            
            break;
            
        case 3:
            const step3Fields = [
                { id: 'collateral-description', type: 'text' },
                { id: 'collateral-value', type: 'amount' }
            ];
            
            step3Fields.forEach(field => {
                if (!validateField(field.id, field.type)) {
                    isValid = false;
                }
            });
            
            if (!applicationData.collateralInfo['collateral-type']) {
                document.getElementById('collateral-type-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('collateral-type-error').style.display = 'none';
            }
            
            const nrcFrontUpload = document.getElementById('nrc-front-upload');
            if (!nrcFrontUpload.classList.contains('has-image')) {
                document.getElementById('nrc-front-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('nrc-front-error').style.display = 'none';
            }
            
            const nrcBackUpload = document.getElementById('nrc-back-upload');
            if (!nrcBackUpload.classList.contains('has-image')) {
                document.getElementById('nrc-back-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('nrc-back-error').style.display = 'none';
            }
            
            const collateralUploads = [
                document.getElementById('collateral-front-upload'),
                document.getElementById('collateral-back-upload'),
                document.getElementById('collateral-left-upload'),
                document.getElementById('collateral-right-upload')
            ];
            
            const hasCollateralPhoto = collateralUploads.some(upload => upload.classList.contains('has-image'));
            
            if (!hasCollateralPhoto) {
                document.getElementById('collateral-photos-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('collateral-photos-error').style.display = 'none';
            }
            
            break;
            
        case 4:
            const step4Fields = [
                { id: 'kin-name', type: 'name' },
                { id: 'kin-relationship', type: 'select' },
                { id: 'kin-phone', type: 'phone' },
                { id: 'kin-email', type: 'email' },
                { id: 'kin-address', type: 'address' }
            ];
            
            step4Fields.forEach(field => {
                if (!validateField(field.id, field.type)) {
                    isValid = false;
                }
            });
            break;
    }
    
    if (isValid) {
        nextStep(step + 1);
    } else {
        const firstError = document.querySelector('.error');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
}

// Loan amount and repayment calculation
function updateLoanAmount(amount) {
    document.getElementById('summary-amount').textContent = 'K' + amount;
    calculateRepayment();
}

function calculateRepayment() {
    const amount = parseInt(document.getElementById('loan-amount-input').value) || 2500;
    const period = parseInt(document.getElementById('repayment-period').value);
    
    let interestRate;
    switch(period) {
        case 7: interestRate = 0.20; break;
        case 14: interestRate = 0.25; break;
        case 21: interestRate = 0.30; break;
        case 30: interestRate = 0.35; break;
        case 60: interestRate = 0.50; break;
        default: interestRate = 0.35;
    }
    
    const interestAmount = Math.round(amount * interestRate);
    const totalRepayment = amount + interestAmount + 50;
    
    document.getElementById('summary-interest').textContent = (interestRate * 100) + '%';
    document.getElementById('summary-interest-amount').textContent = 'K' + interestAmount;
    document.getElementById('summary-total').textContent = 'K' + totalRepayment;
    
    generateRepaymentSchedule(amount, period, interestRate);
    
    applicationData.loanDetails.amount = amount;
    applicationData.loanDetails.period = period;
    applicationData.loanDetails.interestRate = interestRate;
    applicationData.loanDetails.totalRepayment = totalRepayment;
}

function generateRepaymentSchedule(amount, periodDays, interestRate) {
    const scheduleList = document.getElementById('repayment-schedule-list');
    scheduleList.innerHTML = '';
    
    const interestAmount = Math.round(amount * interestRate);
    const totalRepayment = amount + interestAmount + 50;
    const dailyPayment = Math.round(totalRepayment / (periodDays / 7) * 7) / periodDays;
    
    const startDate = new Date();
    
    for (let i = 1; i <= Math.ceil(periodDays / 7); i++) {
        const paymentDate = new Date(startDate);
        paymentDate.setDate(startDate.getDate() + (i * 7));
        
        const scheduleItem = document.createElement('div');
        scheduleItem.className = 'schedule-item';
        
        const weekAmount = i === Math.ceil(periodDays / 7) ? 
            totalRepayment - (dailyPayment * (i - 1) * 7) : 
            Math.round(dailyPayment * 7);
        
        scheduleItem.innerHTML = `
            <div class="schedule-date">Week ${i} - ${paymentDate.toLocaleDateString()}</div>
            <div class="schedule-amount">K${weekAmount}</div>
        `;
        
        scheduleList.appendChild(scheduleItem);
    }
}

// Loan calculator
function calculateLoan() {
    const amount = parseInt(document.getElementById('calc-amount').value) || 2500;
    const period = parseInt(document.getElementById('calc-period').value);
    
    let interestRate;
    switch(period) {
        case 7: interestRate = 0.20; break;
        case 14: interestRate = 0.25; break;
        case 21: interestRate = 0.30; break;
        case 30: interestRate = 0.35; break;
        case 60: interestRate = 0.50; break;
        default: interestRate = 0.35;
    }
    
    const interestAmount = Math.round(amount * interestRate);
    const totalRepayment = amount + interestAmount + 50;
    
    document.getElementById('calc-total').textContent = 'K' + totalRepayment;
}

// File upload and preview
function handleFileUpload(input, uploadContainerId) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const uploadContainer = document.getElementById(uploadContainerId);
            uploadContainer.innerHTML = '';
            uploadContainer.classList.add('has-image');
            
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.style.borderRadius = uploadContainerId.includes('file-upload') ? '50%' : 'var(--radius)';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-preview';
            removeBtn.innerHTML = '<i class="fa-solid fa-times"></i>';
            removeBtn.onclick = function(e) {
                e.stopPropagation();
                uploadContainer.innerHTML = '<i class="fa-solid fa-cloud-upload-alt"></i><div class="file-upload-text">Click to upload</div>';
                uploadContainer.classList.remove('has-image');
                input.value = '';
                delete uploadedFiles[input.id];
            };
            
            uploadContainer.appendChild(img);
            uploadContainer.appendChild(removeBtn);
            uploadedFiles[input.id] = file;
        };
        reader.readAsDataURL(file);
    }
}

// Update review section
function updateReviewSection() {
    document.getElementById('review-name').textContent = applicationData.personalInfo['full-name'] || '-';
    document.getElementById('review-phone').textContent = applicationData.personalInfo['phone-number'] || '-';
    document.getElementById('review-email').textContent = applicationData.personalInfo.email || '-';
    document.getElementById('review-dob').textContent = applicationData.personalInfo.dob || '-';
    document.getElementById('review-national-id').textContent = applicationData.personalInfo['national-id'] || '-';
    document.getElementById('review-address').textContent = applicationData.personalInfo.address || '-';
    document.getElementById('review-city').textContent = applicationData.personalInfo.city || '-';
    document.getElementById('review-employment').textContent = applicationData.personalInfo['employment-status'] || '-';
    document.getElementById('review-income').textContent = 'K' + (applicationData.personalInfo['monthly-income'] || '0');
    document.getElementById('review-employer').textContent = applicationData.personalInfo['employer-name'] || '-';
    document.getElementById('review-occupation').textContent = applicationData.personalInfo.occupation || '-';
    
    document.getElementById('review-loan-amount').textContent = 'K' + (applicationData.loanDetails.amount || '0');
    document.getElementById('review-term').textContent = getTermText(applicationData.loanDetails.period);
    document.getElementById('review-interest').textContent = (applicationData.loanDetails.interestRate * 100 || '0') + '%';
    document.getElementById('review-total').textContent = 'K' + (applicationData.loanDetails.totalRepayment || '0');
    document.getElementById('review-reason').textContent = applicationData.loanDetails['loan-reason'] || '-';
    document.getElementById('review-purpose').textContent = applicationData.loanDetails['loan-purpose'] || '-';
    
    document.getElementById('review-collateral').textContent = applicationData.collateralInfo['collateral-type'] || '-';
    document.getElementById('review-collateral-desc').textContent = applicationData.collateralInfo['collateral-description'] || '-';
    document.getElementById('review-collateral-value').textContent = 'K' + (applicationData.collateralInfo['collateral-value'] || '0');
    
    document.getElementById('review-kin-name').textContent = applicationData.nextOfKin['kin-name'] || '-';
    document.getElementById('review-kin-relationship').textContent = applicationData.nextOfKin['kin-relationship'] || '-';
    document.getElementById('review-kin-phone').textContent = applicationData.nextOfKin['kin-phone'] || '-';
    document.getElementById('review-kin-email').textContent = applicationData.nextOfKin['kin-email'] || '-';
    document.getElementById('review-kin-address').textContent = applicationData.nextOfKin['kin-address'] || '-';
}

function getTermText(period) {
    switch(period) {
        case 7: return '1 Week';
        case 14: return '2 Weeks';
        case 21: return '3 Weeks';
        case 30: return '1 Month';
        case 60: return '2 Months';
        default: return '-';
    }
}

// Upload file to Firebase Storage and get URL
async function uploadFileToStorage(file, filePath) {
    return new Promise((resolve, reject) => {
        const storageRef = storage.ref(filePath);
        const uploadTask = storageRef.put(file);
        
        uploadTask.on('state_changed',
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log(`Upload is ${progress}% done`);
            },
            (error) => {
                reject(error);
            },
            () => {
                uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                    resolve(downloadURL);
                });
            }
        );
    });
}

// Submit application to Firebase
async function submitApplication() {
    if (!document.getElementById('agree-terms').checked) {
        document.getElementById('agree-terms-error').style.display = 'block';
        document.getElementById('agree-terms').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    } else {
        document.getElementById('agree-terms-error').style.display = 'none';
    }
    
    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<div class="spinner"></div> Submitting...';
    submitBtn.disabled = true;
    
    try {
        const applicationId = 'APP' + Date.now();
        const documentUrls = {};
        
        // Upload all files to Firebase Storage
        for (const [fieldId, file] of Object.entries(uploadedFiles)) {
            const filePath = `applications/${currentUser.uid}/${applicationId}/${fieldId}`;
            const progressId = fieldId + '-progress';
            const progressBarId = fieldId + '-progress-bar';
            document.getElementById(progressId).style.display = 'block';
            
            try {
                const downloadURL = await uploadFileToStorage(file, filePath);
                documentUrls[fieldId] = downloadURL;
                document.getElementById(progressId).style.display = 'none';
            } catch (error) {
                console.error(`Error uploading ${fieldId}:`, error);
                throw new Error(`Failed to upload ${fieldId}`);
            }
        }
        
        // Prepare application data
        const applicationDataForFirestore = {
            ...applicationData,
            documents: documentUrls,
            applicationId: applicationId,
            userId: currentUser.uid,
            status: 'pending',
            submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Save to Firestore
        await db.collection('applications').doc(applicationId).set(applicationDataForFirestore);
        
        // Save to Realtime Database
        const realtimeApplicationData = {
            ...applicationData,
            documents: documentUrls,
            applicationId: applicationId,
            userId: currentUser.uid,
            status: 'pending',
            submittedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        await realtimeDb.ref(`applications/${applicationId}`).set(realtimeApplicationData);
        
        // Create notification
        await db.collection('notifications').add({
            userId: currentUser.uid,
            title: 'Application Submitted',
            message: 'Your loan application has been received and is under review.',
            type: 'application',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update user stats
        await updateUserStats();
        
        showToast('Application submitted successfully!', 'success');
        
        setTimeout(() => {
            resetApplicationForm();
            showPage('loans-page');
        }, 2000);
        
    } catch (error) {
        console.error('Error submitting application:', error);
        showToast('Error submitting application. Please try again.', 'error');
        
        if (error.code === 'unavailable') {
            document.getElementById('offline-indicator').classList.add('show');
        }
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// Load user data from Firebase
async function loadUserData() {
    await Promise.all([
        loadUserProfile(),
        updateUserStats()
    ]);
}

// Update loans display
function updateLoansDisplay() {
    const activeLoansContainer = document.getElementById('active-loans-container');
    const pendingContainer = document.getElementById('pending-applications-container');
    const historyContainer = document.getElementById('loan-history-container');
    
    activeLoansContainer.innerHTML = '';
    pendingContainer.innerHTML = '';
    historyContainer.innerHTML = '';
    
    const pendingApplications = userLoans.filter(app => app.status === 'pending');
    const activeLoans = userLoans.filter(app => app.status === 'approved');
    const loanHistory = userLoans.filter(app => app.status === 'completed' || app.status === 'rejected');
    
    if (pendingApplications.length > 0) {
        pendingApplications.forEach(application => {
            const loanItem = createLoanItem(application);
            pendingContainer.appendChild(loanItem);
        });
    } else {
        pendingContainer.innerHTML = '<div class="empty-state"><i class="fa-solid fa-clock"></i><p>No pending applications</p></div>';
    }
    
    if (activeLoans.length > 0) {
        activeLoans.forEach(loan => {
            const loanItem = createLoanItem(loan);
            activeLoansContainer.appendChild(loanItem);
        });
    } else {
        activeLoansContainer.innerHTML = '<div class="empty-state"><i class="fa-solid fa-hand-holding-dollar"></i><p>No active loans</p></div>';
    }
    
    if (loanHistory.length > 0) {
        loanHistory.forEach(loan => {
            const loanItem = createLoanItem(loan);
            historyContainer.appendChild(loanItem);
        });
    } else {
        historyContainer.innerHTML = '<div class="empty-state"><i class="fa-solid fa-receipt"></i><p>No previous loans</p></div>';
    }
}

function createLoanItem(loan) {
    const loanItem = document.createElement('div');
    loanItem.className = 'loan-item';
    
    let statusBadge = '';
    if (loan.status === 'approved') {
        statusBadge = `<div class="loan-status status-approved">Approved</div>`;
    } else if (loan.status === 'pending') {
        statusBadge = `<div class="loan-status status-pending">Pending</div>`;
    } else if (loan.status === 'rejected') {
        statusBadge = `<div class="loan-status status-rejected">Rejected</div>`;
    } else if (loan.status === 'completed') {
        statusBadge = `<div class="loan-status status-completed">Completed</div>`;
    }
    
    const submittedDate = loan.submittedAt ? loan.submittedAt.toDate().toLocaleDateString() : 'Unknown date';
    const loanAmount = loan.loanDetails ? loan.loanDetails.amount : 0;
    
    let loanInfo = '';
    if (loan.status === 'approved' || loan.status === 'completed') {
        const totalRepayment = loan.loanDetails ? loan.loanDetails.totalRepayment : 0;
        loanInfo = `
            <div class="loan-info">
                <div class="loan-info-label">Amount</div>
                <div class="loan-info-value">K${loanAmount}</div>
            </div>
            <div class="loan-info">
                <div class="loan-info-label">Total Repayment</div>
                <div class="loan-info-value">K${totalRepayment}</div>
            </div>
        `;
    } else {
        loanInfo = `
            <div class="loan-info">
                <div class="loan-info-label">Amount</div>
                <div class="loan-info-value">K${loanAmount}</div>
            </div>
        `;
    }
    
    loanItem.innerHTML = `
        <div class="loan-header">
            <div class="loan-details">
                <div class="loan-title">Loan Application</div>
                <div class="loan-date">Applied: ${submittedDate}</div>
            </div>
            ${statusBadge}
        </div>
        ${loanInfo}
    `;
    
    return loanItem;
}

// Load user profile
async function loadUserProfile() {
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            
            document.getElementById('profile-name').textContent = userData.name || 'User';
            document.getElementById('profile-phone').textContent = userData.phone || 'No phone';
            document.getElementById('profile-name-input').value = userData.name || '';
            document.getElementById('profile-phone-input').value = userData.phone || '';
            document.getElementById('profile-email-input').value = userData.email || '';
            document.getElementById('profile-dob-input').value = userData.dob || '';
            document.getElementById('profile-id-input').value = userData.nationalId || '';
            document.getElementById('referral-code').textContent = userData.referralCode || 'DMK-5A8B2C';
            document.getElementById('credit-score-value').textContent = userData.creditScore || '720';
            
            // Update application data with profile info
            applicationData.personalInfo['full-name'] = userData.name || '';
            applicationData.personalInfo['phone-number'] = userData.phone || '';
            applicationData.personalInfo.email = userData.email || '';
            applicationData.personalInfo.dob = userData.dob || '';
            applicationData.personalInfo['national-id'] = userData.nationalId || '';
            applicationData.personalInfo['employment-status'] = userData.employmentStatus || '';
            applicationData.personalInfo['monthly-income'] = userData.monthlyIncome || '';
            applicationData.personalInfo['employer-name'] = userData.employerName || '';
            applicationData.personalInfo.occupation = userData.occupation || '';
            applicationData.personalInfo['bank-name'] = userData.bankName || '';
            applicationData.personalInfo['account-number'] = userData.accountNumber || '';
            applicationData.personalInfo['branch-code'] = userData.branchCode || '';
        }
    } catch (error) {
        console.error('Error loading user profile:', error);
    }
}

// Update user stats based on real data
async function updateUserStats() {
    try {
        const totalLoans = userLoans.length;
        const activeLoans = userLoans.filter(loan => loan.status === 'approved').length;
        
        // Calculate next payment from active loans
        let nextPayment = 0;
        let dueDate = '-';
        const activeLoan = userLoans.find(loan => loan.status === 'approved');
        if (activeLoan && activeLoan.loanDetails) {
            const weeklyPayment = Math.ceil(activeLoan.loanDetails.totalRepayment / 4);
            nextPayment = weeklyPayment;
            
            // Calculate due date (one week from now)
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            dueDate = nextWeek.toLocaleDateString();
        }
        
        // Update user stats in Firestore
        await db.collection('userStats').doc(currentUser.uid).set({
            totalLoans: totalLoans,
            activeLoans: activeLoans,
            creditScore: userStats.creditScore,
            referralEarnings: userStats.referralEarnings,
            nextPayment: nextPayment,
            dueDate: dueDate,
            interestRate: activeLoan ? (activeLoan.loanDetails.interestRate * 100) + '%' : '0%',
            availableLimit: 6000 - (activeLoans > 0 ? activeLoan.loanDetails.amount : 0),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
    } catch (error) {
        console.error('Error updating user stats:', error);
    }
}

// Update dashboard widgets with real data
function updateDashboardWidgets() {
    document.getElementById('total-loans').textContent = userStats.totalLoans || 0;
    document.getElementById('active-loans').textContent = userStats.activeLoans || 0;
    document.getElementById('credit-score').textContent = userStats.creditScore || '720';
    document.getElementById('referral-earnings').textContent = 'K' + (userStats.referralEarnings || '0');
    document.getElementById('next-payment').textContent = 'K' + (userStats.nextPayment || '0');
    document.getElementById('due-date').textContent = userStats.dueDate || '-';
    document.getElementById('interest-rate').textContent = userStats.interestRate || '0%';
    document.getElementById('available-limit').textContent = 'K' + (userStats.availableLimit || '6000').toLocaleString();
}

// Update payments display
function updatePaymentsDisplay() {
    const paymentHistoryContainer = document.getElementById('payment-history-container');
    const paymentLoanSelect = document.getElementById('payment-loan-select');
    
    paymentHistoryContainer.innerHTML = '';
    paymentLoanSelect.innerHTML = '<option value="">Select a loan to pay</option>';
    
    const approvedLoans = userLoans.filter(loan => loan.status === 'approved');
    
    if (approvedLoans.length > 0) {
        approvedLoans.forEach(loan => {
            const option = document.createElement('option');
            option.value = loan.applicationId;
            option.textContent = `Loan #${loan.applicationId} - K${loan.loanDetails.amount}`;
            paymentLoanSelect.appendChild(option);
        });
    }
    
    if (userPayments.length > 0) {
        userPayments.forEach(payment => {
            const paymentItem = createPaymentItem(payment);
            paymentHistoryContainer.appendChild(paymentItem);
        });
    } else {
        paymentHistoryContainer.innerHTML = '<div class="empty-state"><i class="fa-solid fa-receipt"></i><p>No payment history</p></div>';
    }
}

function createPaymentItem(payment) {
    const paymentItem = document.createElement('div');
    paymentItem.className = 'loan-item';
    
    const paymentDate = payment.paymentDate ? payment.paymentDate.toDate().toLocaleDateString() : 'Unknown date';
    
    paymentItem.innerHTML = `
        <div class="loan-header">
            <div class="loan-details">
                <div class="loan-title">Payment for Loan #${payment.loanId}</div>
                <div class="loan-date">Paid: ${paymentDate}</div>
            </div>
            <div class="loan-amount-badge">K${payment.amount}</div>
        </div>
        <div class="loan-info">
            <div class="loan-info-label">Payment Method</div>
            <div class="loan-info-value">${payment.method}</div>
        </div>
        <div class="loan-info">
            <div class="loan-info-label">Status</div>
            <div class="loan-info-value">${payment.status || 'Completed'}</div>
        </div>
    `;
    
    return paymentItem;
}

// Make a payment
async function makePayment() {
    const loanId = document.getElementById('payment-loan-select').value;
    const amount = document.getElementById('payment-amount').value;
    const selectedMethod = document.querySelector('.payment-method.selected');
    
    if (!loanId || !amount || !selectedMethod) {
        showToast('Please fill all payment details', 'error');
        return;
    }
    
    const method = selectedMethod.getAttribute('data-method');
    
    try {
        const paymentId = 'PAY' + Date.now();
        await db.collection('payments').doc(paymentId).set({
            paymentId: paymentId,
            userId: currentUser.uid,
            loanId: loanId,
            amount: parseInt(amount),
            method: method,
            status: 'completed',
            paymentDate: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create payment notification
        await db.collection('notifications').add({
            userId: currentUser.uid,
            title: 'Payment Received',
            message: `Your payment of K${amount} has been successfully processed.`,
            type: 'payment',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('Payment submitted successfully!', 'success');
        
        document.getElementById('payment-amount').value = '';
        document.querySelectorAll('.payment-method').forEach(m => {
            m.classList.remove('selected');
        });
        
    } catch (error) {
        console.error('Error making payment:', error);
        showToast('Error processing payment. Please try again.', 'error');
    }
}

// Copy referral code
function copyReferralCode() {
    const referralCode = document.getElementById('referral-code').textContent;
    navigator.clipboard.writeText(referralCode)
        .then(() => {
            showToast('Referral code copied to clipboard!', 'success');
        })
        .catch(err => {
            console.error('Failed to copy: ', err);
            showToast('Failed to copy referral code', 'error');
        });
}

// Show referral section
function showReferralSection() {
    showPage('profile-page');
    setTimeout(() => {
        document.querySelector('.referral-code').scrollIntoView({ behavior: 'smooth' });
    }, 300);
}

// Update notification badge
function updateNotificationBadge() {
    const badge = document.getElementById('notification-count');
    const unreadCount = notifications.length;
    
    if (unreadCount > 0) {
        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

// Update notification list
function updateNotificationList() {
    const notificationList = document.getElementById('notification-list');
    notificationList.innerHTML = '';
    
    notifications.forEach(notification => {
        const notificationItem = document.createElement('div');
        notificationItem.className = 'notification-item';
        notificationItem.addEventListener('click', () => markNotificationAsRead(notification.id));
        
        const notificationDate = notification.createdAt ? notification.createdAt.toDate().toLocaleDateString() : 'Unknown date';
        
        notificationItem.innerHTML = `
            <div class="notification-title">${notification.title}</div>
            <div class="notification-message">${notification.message}</div>
            <div class="notification-time">${notificationDate}</div>
        `;
        notificationList.appendChild(notificationItem);
    });
}

// Mark notification as read
async function markNotificationAsRead(notificationId) {
    try {
        await db.collection('notifications').doc(notificationId).update({
            read: true,
            readAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

// Toast notifications
function showToast(message, type = '') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Update user profile
async function updateProfile() {
    const name = document.getElementById('profile-name-input').value;
    const phone = document.getElementById('profile-phone-input').value;
    const email = document.getElementById('profile-email-input').value;
    const dob = document.getElementById('profile-dob-input').value;
    const nationalId = document.getElementById('profile-id-input').value;
    
    try {
        await db.collection('users').doc(currentUser.uid).update({
            name: name,
            phone: phone,
            email: email,
            dob: dob,
            nationalId: nationalId,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('Profile updated successfully!', 'success');
        
        document.getElementById('profile-name').textContent = name;
        document.getElementById('profile-phone').textContent = phone;
        
    } catch (error) {
        console.error('Error updating profile:', error);
        showToast('Error updating profile. Please try again.', 'error');
    }
}

// Initialize the app
function initApp() {
    calculateRepayment();
    calculateLoan();
    
    document.getElementById('make-payment-btn').addEventListener('click', makePayment);
    document.getElementById('update-profile-btn').addEventListener('click', updateProfile);
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

